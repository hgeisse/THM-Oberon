/*
 * kbd.c -- keyboard simulation
 */


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <setjmp.h>
#include <pthread.h>

#include "common.h"
#include "console.h"
#include "error.h"
#include "except.h"
#include "cpu.h"
#include "timer.h"
#include "kbd.h"


#define COMMAND_RESET		0xFF
#define COMMAND_ECHO		0xEE

#define ANSWER_ACK		0xFA
#define ANSWER_ECHO		0xEE
#define ANSWER_BATOK		0xAA


static Bool debug = false;
static Bool debugKeycode = false;
static Bool installed = false;

static pthread_mutex_t lock;


/**************************************************************/


#define MAX_MAKE	2
#define MAX_BREAK	3


typedef struct {
  unsigned int xKeycode;
  int pcNumMake;
  Byte pcKeyMake[MAX_MAKE];
  int pcNumBreak;
  Byte pcKeyBreak[MAX_BREAK];
} Keycode;


static Keycode kbdCodeTbl[] = {
  { 0x09, 1, { 0x76, 0x00 }, 2, { 0xF0, 0x76, 0x00 } },
  { 0x43, 1, { 0x05, 0x00 }, 2, { 0xF0, 0x05, 0x00 } },
  { 0x44, 1, { 0x06, 0x00 }, 2, { 0xF0, 0x06, 0x00 } },
  { 0x45, 1, { 0x04, 0x00 }, 2, { 0xF0, 0x04, 0x00 } },
  { 0x46, 1, { 0x0C, 0x00 }, 2, { 0xF0, 0x0C, 0x00 } },
  { 0x47, 1, { 0x03, 0x00 }, 2, { 0xF0, 0x03, 0x00 } },
  { 0x48, 1, { 0x0B, 0x00 }, 2, { 0xF0, 0x0B, 0x00 } },
  { 0x49, 1, { 0x83, 0x00 }, 2, { 0xF0, 0x83, 0x00 } },
  { 0x4A, 1, { 0x0A, 0x00 }, 2, { 0xF0, 0x0A, 0x00 } },
  { 0x4B, 1, { 0x01, 0x00 }, 2, { 0xF0, 0x01, 0x00 } },
  { 0x4C, 1, { 0x09, 0x00 }, 2, { 0xF0, 0x09, 0x00 } },
  { 0x5F, 1, { 0x78, 0x00 }, 2, { 0xF0, 0x78, 0x00 } },
  { 0x60, 1, { 0x07, 0x00 }, 2, { 0xF0, 0x07, 0x00 } },
  /*------------------------------------------------*/
  { 0x31, 1, { 0x0E, 0x00 }, 2, { 0xF0, 0x0E, 0x00 } },
  { 0x0A, 1, { 0x16, 0x00 }, 2, { 0xF0, 0x16, 0x00 } },
  { 0x0B, 1, { 0x1E, 0x00 }, 2, { 0xF0, 0x1E, 0x00 } },
  { 0x0C, 1, { 0x26, 0x00 }, 2, { 0xF0, 0x26, 0x00 } },
  { 0x0D, 1, { 0x25, 0x00 }, 2, { 0xF0, 0x25, 0x00 } },
  { 0x0E, 1, { 0x2E, 0x00 }, 2, { 0xF0, 0x2E, 0x00 } },
  { 0x0F, 1, { 0x36, 0x00 }, 2, { 0xF0, 0x36, 0x00 } },
  { 0x10, 1, { 0x3D, 0x00 }, 2, { 0xF0, 0x3D, 0x00 } },
  { 0x11, 1, { 0x3E, 0x00 }, 2, { 0xF0, 0x3E, 0x00 } },
  { 0x12, 1, { 0x46, 0x00 }, 2, { 0xF0, 0x46, 0x00 } },
  { 0x13, 1, { 0x45, 0x00 }, 2, { 0xF0, 0x45, 0x00 } },
  { 0x14, 1, { 0x4E, 0x00 }, 2, { 0xF0, 0x4E, 0x00 } },
  { 0x15, 1, { 0x55, 0x00 }, 2, { 0xF0, 0x55, 0x00 } },
  { 0x16, 1, { 0x66, 0x00 }, 2, { 0xF0, 0x66, 0x00 } },
  /*------------------------------------------------*/
  { 0x17, 1, { 0x0D, 0x00 }, 2, { 0xF0, 0x0D, 0x00 } },
  { 0x18, 1, { 0x15, 0x00 }, 2, { 0xF0, 0x15, 0x00 } },
  { 0x19, 1, { 0x1D, 0x00 }, 2, { 0xF0, 0x1D, 0x00 } },
  { 0x1A, 1, { 0x24, 0x00 }, 2, { 0xF0, 0x24, 0x00 } },
  { 0x1B, 1, { 0x2D, 0x00 }, 2, { 0xF0, 0x2D, 0x00 } },
  { 0x1C, 1, { 0x2C, 0x00 }, 2, { 0xF0, 0x2C, 0x00 } },
  { 0x1D, 1, { 0x35, 0x00 }, 2, { 0xF0, 0x35, 0x00 } },
  { 0x1E, 1, { 0x3C, 0x00 }, 2, { 0xF0, 0x3C, 0x00 } },
  { 0x1F, 1, { 0x43, 0x00 }, 2, { 0xF0, 0x43, 0x00 } },
  { 0x20, 1, { 0x44, 0x00 }, 2, { 0xF0, 0x44, 0x00 } },
  { 0x21, 1, { 0x4D, 0x00 }, 2, { 0xF0, 0x4D, 0x00 } },
  { 0x22, 1, { 0x54, 0x00 }, 2, { 0xF0, 0x54, 0x00 } },
  { 0x23, 1, { 0x5B, 0x00 }, 2, { 0xF0, 0x5B, 0x00 } },
  { 0x24, 1, { 0x5A, 0x00 }, 2, { 0xF0, 0x5A, 0x00 } },
  { 0x4E, 1, { 0x7E, 0x00 }, 2, { 0xF0, 0x7E, 0x00 } },
  /*------------------------------------------------*/
  { 0x42, 1, { 0x58, 0x00 }, 2, { 0xF0, 0x58, 0x00 } },
  { 0x26, 1, { 0x1C, 0x00 }, 2, { 0xF0, 0x1C, 0x00 } },
  { 0x27, 1, { 0x1B, 0x00 }, 2, { 0xF0, 0x1B, 0x00 } },
  { 0x28, 1, { 0x23, 0x00 }, 2, { 0xF0, 0x23, 0x00 } },
  { 0x29, 1, { 0x2B, 0x00 }, 2, { 0xF0, 0x2B, 0x00 } },
  { 0x2A, 1, { 0x34, 0x00 }, 2, { 0xF0, 0x34, 0x00 } },
  { 0x2B, 1, { 0x33, 0x00 }, 2, { 0xF0, 0x33, 0x00 } },
  { 0x2C, 1, { 0x3B, 0x00 }, 2, { 0xF0, 0x3B, 0x00 } },
  { 0x2D, 1, { 0x42, 0x00 }, 2, { 0xF0, 0x42, 0x00 } },
  { 0x2E, 1, { 0x4B, 0x00 }, 2, { 0xF0, 0x4B, 0x00 } },
  { 0x2F, 1, { 0x4C, 0x00 }, 2, { 0xF0, 0x4C, 0x00 } },
  { 0x30, 1, { 0x52, 0x00 }, 2, { 0xF0, 0x52, 0x00 } },
  { 0x33, 1, { 0x5D, 0x00 }, 2, { 0xF0, 0x5D, 0x00 } },
  /*------------------------------------------------*/
  { 0x32, 1, { 0x12, 0x00 }, 2, { 0xF0, 0x12, 0x00 } },
  { 0x5E, 1, { 0x61, 0x00 }, 2, { 0xF0, 0x61, 0x00 } },
  { 0x34, 1, { 0x1A, 0x00 }, 2, { 0xF0, 0x1A, 0x00 } },
  { 0x35, 1, { 0x22, 0x00 }, 2, { 0xF0, 0x22, 0x00 } },
  { 0x36, 1, { 0x21, 0x00 }, 2, { 0xF0, 0x21, 0x00 } },
  { 0x37, 1, { 0x2A, 0x00 }, 2, { 0xF0, 0x2A, 0x00 } },
  { 0x38, 1, { 0x32, 0x00 }, 2, { 0xF0, 0x32, 0x00 } },
  { 0x39, 1, { 0x31, 0x00 }, 2, { 0xF0, 0x31, 0x00 } },
  { 0x3A, 1, { 0x3A, 0x00 }, 2, { 0xF0, 0x3A, 0x00 } },
  { 0x3B, 1, { 0x41, 0x00 }, 2, { 0xF0, 0x41, 0x00 } },
  { 0x3C, 1, { 0x49, 0x00 }, 2, { 0xF0, 0x49, 0x00 } },
  { 0x3D, 1, { 0x4A, 0x00 }, 2, { 0xF0, 0x4A, 0x00 } },
  { 0x3E, 1, { 0x59, 0x00 }, 2, { 0xF0, 0x59, 0x00 } },
  /*------------------------------------------------*/
  { 0x25, 1, { 0x14, 0x00 }, 2, { 0xF0, 0x14, 0x00 } },
  { 0x73, 2, { 0xE0, 0x69 }, 3, { 0xE0, 0xF0, 0x69 } },
  { 0x40, 1, { 0x11, 0x00 }, 2, { 0xF0, 0x11, 0x00 } },
  { 0x41, 1, { 0x29, 0x00 }, 2, { 0xF0, 0x29, 0x00 } },
  { 0x71, 2, { 0xE0, 0x6B }, 3, { 0xE0, 0xF0, 0x6B } },
  { 0x74, 2, { 0xE0, 0x72 }, 3, { 0xE0, 0xF0, 0x72 } },
  { 0x75, 2, { 0xE0, 0x7A }, 3, { 0xE0, 0xF0, 0x7A } },
  { 0x6D, 2, { 0xE0, 0x14 }, 3, { 0xE0, 0xF0, 0x14 } },
  { 0x6F, 2, { 0xE0, 0x75 }, 3, { 0xE0, 0xF0, 0x75 } },
  { 0x72, 2, { 0xE0, 0x74 }, 3, { 0xE0, 0xF0, 0x74 } },
  /*------------------------------------------------*/
  { 0x6A, 2, { 0xE0, 0x4A }, 3, { 0xE0, 0xF0, 0x4A } },
  { 0x61, 2, { 0xE0, 0x6C }, 3, { 0xE0, 0xF0, 0x6C } },
  { 0x63, 2, { 0xE0, 0x7D }, 3, { 0xE0, 0xF0, 0x7D } },
  { 0x6B, 2, { 0xE0, 0x71 }, 3, { 0xE0, 0xF0, 0x71 } },
  { 0x67, 2, { 0xE0, 0x69 }, 3, { 0xE0, 0xF0, 0x69 } },
  { 0x69, 2, { 0xE0, 0x7A }, 3, { 0xE0, 0xF0, 0x7A } },
  { 0x62, 2, { 0xE0, 0x75 }, 3, { 0xE0, 0xF0, 0x75 } },
  { 0x64, 2, { 0xE0, 0x6B }, 3, { 0xE0, 0xF0, 0x6B } },
  { 0x68, 2, { 0xE0, 0x5A }, 3, { 0xE0, 0xF0, 0x5A } },
  { 0x66, 2, { 0xE0, 0x74 }, 3, { 0xE0, 0xF0, 0x74 } },
  /*------------------------------------------------*/
  { 0x4D, 1, { 0x77, 0x00 }, 2, { 0xF0, 0x77, 0x00 } },
  { 0x70, 2, { 0xE0, 0x7D }, 3, { 0xE0, 0xF0, 0x7D } },
  { 0x3F, 1, { 0x7C, 0x00 }, 2, { 0xF0, 0x7C, 0x00 } },
  { 0x52, 1, { 0x7B, 0x00 }, 2, { 0xF0, 0x7B, 0x00 } },
  { 0x4F, 1, { 0x6C, 0x00 }, 2, { 0xF0, 0x6C, 0x00 } },
  { 0x50, 1, { 0x75, 0x00 }, 2, { 0xF0, 0x75, 0x00 } },
  { 0x51, 1, { 0x7D, 0x00 }, 2, { 0xF0, 0x7D, 0x00 } },
  { 0x56, 1, { 0x79, 0x00 }, 2, { 0xF0, 0x79, 0x00 } },
  { 0x53, 1, { 0x6B, 0x00 }, 2, { 0xF0, 0x6B, 0x00 } },
  { 0x54, 1, { 0x73, 0x00 }, 2, { 0xF0, 0x73, 0x00 } },
  { 0x55, 1, { 0x74, 0x00 }, 2, { 0xF0, 0x74, 0x00 } },
  { 0x57, 1, { 0x69, 0x00 }, 2, { 0xF0, 0x69, 0x00 } },
  { 0x58, 1, { 0x72, 0x00 }, 2, { 0xF0, 0x72, 0x00 } },
  { 0x59, 1, { 0x7A, 0x00 }, 2, { 0xF0, 0x7A, 0x00 } },
  { 0x6C, 2, { 0xE0, 0x11 }, 3, { 0xE0, 0xF0, 0x11 } },
  { 0x5A, 1, { 0x70, 0x00 }, 2, { 0xF0, 0x70, 0x00 } },
  { 0x5B, 1, { 0x71, 0x00 }, 2, { 0xF0, 0x71, 0x00 } },
  { 0x6E, 2, { 0xE0, 0x6C }, 3, { 0xE0, 0xF0, 0x6C } },
  { 0x76, 2, { 0xE0, 0x70 }, 3, { 0xE0, 0xF0, 0x70 } },
  { 0x77, 2, { 0xE0, 0x71 }, 3, { 0xE0, 0xF0, 0x71 } },
  { 0x85, 2, { 0xE0, 0x1F }, 3, { 0xE0, 0xF0, 0x1F } },
  { 0x86, 2, { 0xE0, 0x27 }, 3, { 0xE0, 0xF0, 0x27 } },
  { 0x87, 2, { 0xE0, 0x2F }, 3, { 0xE0, 0xF0, 0x2F } },
};


static int keycodeCompare(const void *code1, const void *code2) {
  return ((Keycode *) code1)->xKeycode - ((Keycode *) code2)->xKeycode;
}


static void initKeycode(void) {
  qsort(kbdCodeTbl, sizeof(kbdCodeTbl)/sizeof(kbdCodeTbl[0]),
        sizeof(kbdCodeTbl[0]), keycodeCompare);
}


static Keycode *lookupKeycode(unsigned int xKeycode) {
  int lo, hi, tst;
  int res;

  lo = 0;
  hi = sizeof(kbdCodeTbl) / sizeof(kbdCodeTbl[0]) - 1;
  while (lo <= hi) {
    tst = (lo + hi) / 2;
    res = kbdCodeTbl[tst].xKeycode - xKeycode;
    if (res == 0) {
      return &kbdCodeTbl[tst];
    }
    if (res < 0) {
      lo = tst + 1;
    } else {
      hi = tst - 1;
    }
  }
  return NULL;
}


/**************************************************************/


#define KBD_BUF_MAX		1000
#define KBD_BUF_MIN_FREE	((MAX_MAKE + MAX_BREAK) * 4)
#define KBD_BUF_NEXT(p)		(((p) + 1) % KBD_BUF_MAX)


static Byte kbdBuf[KBD_BUF_MAX];
static int kbdBufWritePtr;
static int kbdBufReadPtr;


static void kbdBufInit(void) {
  initKeycode();
  kbdBufWritePtr = 0;
  kbdBufReadPtr = 0;
}


static int kbdBufFree(void) {
  if (kbdBufReadPtr <= kbdBufWritePtr) {
    return KBD_BUF_MAX - (kbdBufWritePtr - kbdBufReadPtr) - 1;
  } else {
    return (kbdBufReadPtr - kbdBufWritePtr) - 1;
  }
}


static void kbdBufWrite(Byte *p, int n) {
  int i;

  pthread_mutex_lock(&lock);
  if (kbdBufFree() < KBD_BUF_MIN_FREE) {
    /* buffer full */
    pthread_mutex_unlock(&lock);
    return;
  }
  for (i = 0; i < n; i++) {
    kbdBuf[kbdBufWritePtr] = p[i];
    kbdBufWritePtr = KBD_BUF_NEXT(kbdBufWritePtr);
  }
  pthread_mutex_unlock(&lock);
}


void keyPressed(unsigned int xKeycode) {
  Keycode *p;

  if (debugKeycode) {
    cPrintf("**** KEY PRESSED: 0x%08X ****\n", xKeycode);
  }
  p = lookupKeycode(xKeycode);
  if (p == NULL) {
    /* keycode not found */
    return;
  }
  kbdBufWrite(p->pcKeyMake, p->pcNumMake);
}


void keyReleased(unsigned int xKeycode) {
  Keycode *p;

  if (debugKeycode) {
    cPrintf("**** KEY RELEASED: 0x%08X ****\n", xKeycode);
  }
  p = lookupKeycode(xKeycode);
  if (p == NULL) {
    /* keycode not found */
    return;
  }
  kbdBufWrite(p->pcKeyBreak, p->pcNumBreak);
}


/**************************************************************/


static Word kbdCtrl;
static Word kbdRcvrData;
static Word kbdXmtrData;


static void kbdRcvrCallback(int dev) {
  if (debug) {
    cPrintf("\n**** KEYBOARD RCVR CALLBACK ****\n");
  }
  timerStart(KEYBOARD_RCVR_USEC, kbdRcvrCallback, dev);
  if (kbdBufWritePtr == kbdBufReadPtr || (kbdCtrl & KEYBOARD_RCVR_RDY)) {
    /* no character ready, or last character not yet read */
    return;
  }
  /* any character typed */
  kbdRcvrData = kbdBuf[kbdBufReadPtr];
  kbdBufReadPtr = KBD_BUF_NEXT(kbdBufReadPtr);
  kbdCtrl |= KEYBOARD_RCVR_RDY;
  if (kbdCtrl & KEYBOARD_RCVR_IEN) {
    /* raise keyboard interrupt */
    cpuSetInterrupt(IRQ_KEYBOARD);
  }
}


static void kbdXmtrCallback(int dev) {
  Byte b;

  if (debug) {
    cPrintf("\n**** KEYBOARD XMTR CALLBACK ****\n");
  }
  switch (kbdXmtrData) {
    case COMMAND_RESET:
      kbdBufInit();
      b = ANSWER_ACK;
      kbdBufWrite(&b, 1);
      b = ANSWER_BATOK;
      kbdBufWrite(&b, 1);
      break;
    case COMMAND_ECHO:
      b = ANSWER_ECHO;
      kbdBufWrite(&b, 1);
      break;
    default:
      /*
       * Note: Byte <kbdXmtrData> has been sent to the
       *       keyboard and is acknowledged (but ignored).
       */
      b = ANSWER_ACK;
      kbdBufWrite(&b, 1);
      break;
  }
  kbdCtrl |= KEYBOARD_XMTR_RDY;
  if (kbdCtrl & KEYBOARD_XMTR_IEN) {
    /* raise keyboard interrupt */
    cpuSetInterrupt(IRQ_KEYBOARD);
  }
}


Word keyboardRead(Word addr) {
  Word data;

  if (debug) {
    cPrintf("\n**** KEYBOARD READ from 0x%08X", addr);
  }
  if (!installed) {
    throwException(EXC_BUS_TIMEOUT);
  }
  if (addr == KEYBOARD_CTRL) {
    data = kbdCtrl;
  } else
  if (addr == KEYBOARD_DATA) {
    kbdCtrl &= ~KEYBOARD_RCVR_RDY;
    if (kbdCtrl & KEYBOARD_RCVR_IEN) {
      /* lower keyboard interrupt */
      cpuResetInterrupt(IRQ_KEYBOARD);
    }
    data = kbdRcvrData;
  } else {
    /* illegal register */
    throwException(EXC_BUS_TIMEOUT);
  }
  if (debug) {
    cPrintf(", data = 0x%08X ****\n", data);
  }
  return data;
}


void keyboardWrite(Word addr, Word data) {
  if (debug) {
    cPrintf("\n**** KEYBOARD WRITE to 0x%08X, data = 0x%08X ****\n",
            addr, data);
  }
  if (!installed) {
    throwException(EXC_BUS_TIMEOUT);
  }
  if (addr == KEYBOARD_CTRL) {
    if (data & KEYBOARD_RCVR_IEN) {
      kbdCtrl |= KEYBOARD_RCVR_IEN;
    } else {
      kbdCtrl &= ~KEYBOARD_RCVR_IEN;
    }
    if (data & KEYBOARD_XMTR_IEN) {
      kbdCtrl |= KEYBOARD_XMTR_IEN;
    } else {
      kbdCtrl &= ~KEYBOARD_XMTR_IEN;
    }
    if (((kbdCtrl & KEYBOARD_RCVR_IEN) != 0 &&
         (kbdCtrl & KEYBOARD_RCVR_RDY) != 0) ||
        ((kbdCtrl & KEYBOARD_XMTR_IEN) != 0 &&
         (kbdCtrl & KEYBOARD_XMTR_RDY) != 0)) {
      /* raise keyboard interrupt */
      cpuSetInterrupt(IRQ_KEYBOARD);
    } else {
      /* lower keyboard interrupt */
      cpuResetInterrupt(IRQ_KEYBOARD);
    }
  } else
  if (addr == KEYBOARD_DATA) {
    kbdXmtrData = data & 0xFF;
    kbdCtrl &= ~KEYBOARD_XMTR_RDY;
    if (kbdCtrl & KEYBOARD_XMTR_IEN) {
      /* lower keyboard interrupt */
      cpuResetInterrupt(IRQ_KEYBOARD);
    }
    timerStart(KEYBOARD_XMTR_USEC, kbdXmtrCallback, 0);
  } else {
    /* illegal register */
    throwException(EXC_BUS_TIMEOUT);
  }
}


void keyboardReset(void) {
  Byte b;

  if (!installed) {
    return;
  }
  cPrintf("Resetting Keyboard...\n");
  kbdBufInit();
  b = ANSWER_BATOK;
  kbdBufWrite(&b, 1);
  kbdCtrl = KEYBOARD_XMTR_RDY;
  kbdRcvrData = 0;
  kbdXmtrData = 0;
  timerStart(KEYBOARD_RCVR_USEC, kbdRcvrCallback, 0);
}


void keyboardInit(void) {
  if (pthread_mutex_init(&lock, NULL) != 0) {
    error("could not initialize keyboard mutex");
  }
  installed = true;
  keyboardReset();
}


void keyboardExit(void) {
  if (!installed) {
    return;
  }
  pthread_mutex_destroy(&lock);
}
